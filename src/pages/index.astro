---
import AboutHeroImage from '../assets/about-me-header.png';
import Layout from '../layouts/BlogPost.astro';
import ExperienceEntry from '../components/ExperienceEntry.astro';
import EducationEntry from '../components/EducationEntry.astro';
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';

const _allProjects = await getCollection('projects');
const selectedProjects = _allProjects.filter((p) => (p.data && (p.data.selected === true || (p.data.tags && p.data.tags.includes('selected')))));
const experienceEntries = await getCollection('experience');
const educationEntries = await getCollection('education');
const showProjectControls = selectedProjects.length > 1;

const experience = experienceEntries.map((entry) => ({
	...entry.data,
	html: entry.rendered?.html || '',
}));

const education = educationEntries.map((entry) => ({
	...entry.data,
	html: entry.rendered?.html || '',
}));

const sortedExperience = experience.sort((a, b) => {
	const aYears = a.years;
	const bYears = b.years;
	// Prioritize ongoing positions (with "present")
	const aIsPresent = aYears.includes('present');
	const bIsPresent = bYears.includes('present');
	if (aIsPresent && !bIsPresent) return -1;
	if (!aIsPresent && bIsPresent) return 1;
	// Otherwise sort by year descending
	const aFirstYear = parseInt(aYears.split('–')[0].trim());
	const bFirstYear = parseInt(bYears.split('–')[0].trim());
	return bFirstYear - aFirstYear;
});

const sortedEducation = education.sort((a, b) => {
	const aPeriod = a.period;
	const bPeriod = b.period;
	// Prioritize ongoing education (with "Expected")
	const aIsOngoing = aPeriod.includes('Expected');
	const bIsOngoing = bPeriod.includes('Expected');
	if (aIsOngoing && !bIsOngoing) return -1;
	if (!aIsOngoing && bIsOngoing) return 1;
	// Otherwise sort by year descending
	const aYear = parseInt(aPeriod.match(/\d{4}/)?.[0] || '0');
	const bYear = parseInt(bPeriod.match(/\d{4}/)?.[0] || '0');
	return bYear - aYear;
});
---

<Layout
	title="About Me"
	description="Nico Auerswald - Game Developer."
	year="2024"
	heroImage={AboutHeroImage}
	heroPortrait={true}
>
	<p>
		I am a game developer with hands-on experience in Unity and Godot, specializing in gameplay systems, tools development, and graphics programming.
		I am currently completing an MSc in Videogame Studies while teaching game development at university level and having shipped a commercial project.
	</p>

	
	<style>
		.selected-projects { margin-top:2rem; display:flex; flex-direction:column; gap:1rem; }
		.selected-projects__head { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
		.selected-projects__controls { display:flex; align-items:center; gap:0.5rem; }
		.selected-projects__arrow { border:1px solid rgb(var(--black)); background:transparent; color:rgb(var(--black)); padding:0.4rem 0.7rem; border-radius:999px; cursor:pointer; transition:background 160ms ease, color 160ms ease; }
		.selected-projects__arrow:hover { background:rgb(var(--black)); color:rgb(var(--white)); }
		.selected-projects__viewport { overflow:hidden; position:relative; mask-image:linear-gradient(90deg, transparent, black 4%, black 96%, transparent); }
		.selected-projects__track { display:flex; gap:1.5rem; list-style:none; margin:0; padding:0.25rem 0; }
		.selected-projects__card { flex:0 0 calc((100% - 3rem) / 3); max-width:360px; min-width:260px; }
		.selected-projects__link { text-decoration:none; display:block; color:inherit; }
		.selected-projects__image { margin-bottom:0.5rem; border-radius:12px; width:100%; height:auto; aspect-ratio:2 / 1; object-fit:cover; display:block; }
		.selected-projects h3 { margin:0; }
		.selected-projects h5 { margin:0 0 0.1rem 0; color: rgb(var(--black)); line-height:1; font-size: 1.2rem; }
		.selected-projects p { margin:0; color: rgb(var(--gray)); font-size: 1rem; }
		.selected-projects__track::-webkit-scrollbar { display:none; }
		@media (max-width: 960px) {
			.selected-projects__card { flex:0 0 calc((100% - 1.5rem) / 2); max-width:380px; min-width:240px; }
		}
		@media (max-width: 640px) {
			.selected-projects__card { flex-basis: clamp(220px, 80vw, 320px); max-width:none; }
		}
	</style>

	{selectedProjects.length > 0 && (
		<section class="selected-projects">
			<div class="selected-projects__head">
				<h3>Selected Projects</h3>
				{showProjectControls && (
					<div class="selected-projects__controls" aria-label="Selected projects navigation">
						<button class="selected-projects__arrow" type="button" data-direction="prev" aria-label="Previous projects">&larr;</button>
						<button class="selected-projects__arrow" type="button" data-direction="next" aria-label="Next projects">&rarr;</button>
					</div>
				)}
			</div>
			<div class="selected-projects__viewport" data-slider>
				<ul class="selected-projects__track">
					{selectedProjects.map((post) => (
						<li class="selected-projects__card">
							<a class="selected-projects__link" href={`/projects/${post.id}/`}>
								{post.data.heroImage && (
									<Image class="selected-projects__image" width={720} height={360} src={post.data.heroImage} alt="" />
								)}
								<h5>{post.data.title}</h5>
								{/* <p>{post.data.year}</p> */}
								<p>{post.data.category}</p>
							</a>
						</li>
					))}
				</ul>
			</div>
		</section>
	)}

	<script>
		if (typeof window !== 'undefined') {
			const viewport = document.querySelector('[data-slider]');
			const track = viewport?.querySelector('.selected-projects__track');
			const prevButton = document.querySelector('[data-direction="prev"]');
			const nextButton = document.querySelector('[data-direction="next"]');
			const originalCards = Array.from(track?.querySelectorAll('.selected-projects__card') || []);

			if (viewport && track && prevButton && nextButton && originalCards.length) {
				const cloneBefore = originalCards.map(card => card.cloneNode(true));
				const cloneAfter = originalCards.map(card => card.cloneNode(true));
				cloneBefore.reverse().forEach(clone => track.insertBefore(clone, track.firstChild));
				cloneAfter.forEach(clone => track.appendChild(clone));

				const allCards = Array.from(track.querySelectorAll('.selected-projects__card')) as HTMLElement[];
				const originalLength = originalCards.length;
				let currentIndex = originalLength;
				let isScrolling = false;
				let scrollEndTimer: NodeJS.Timeout | null = null;
				let pendingInput: number | null = null;

				const getCardCenter = (card: HTMLElement) => card.offsetLeft + card.clientWidth / 2;
				const getViewportCenter = () => (viewport as HTMLElement).scrollLeft + viewport.clientWidth / 2;

				const scrollToCard = (index: number, smooth = true) => {
					const card = allCards[index];
					if (!card) return;
					const offset = card.offsetLeft - ((viewport as HTMLElement).clientWidth - card.clientWidth) / 2;
					(viewport as HTMLElement).scrollTo({ left: offset, behavior: smooth ? 'smooth' : 'auto' });
				};

				const handleInfiniteLoop = () => {
					if (currentIndex < originalLength) {
						const realIndex = originalLength + currentIndex;
						currentIndex = realIndex;
						scrollToCard(realIndex, false);
					} else if (currentIndex >= originalLength * 2) {
						const realIndex = currentIndex - originalLength;
						currentIndex = realIndex;
						scrollToCard(realIndex, false);
					}
				};

				const findNearestIndex = () => {
					const center = getViewportCenter();
					let nearest = currentIndex;
					let bestDistance = Infinity;
					allCards.forEach((card, idx) => {
						const distance = Math.abs(getCardCenter(card) - center);
						if (distance < bestDistance) {
							bestDistance = distance;
							nearest = idx;
						}
					});
					return nearest;
				};

				const processPendingInput = () => {
					if (pendingInput !== null && !isScrolling) {
						const direction = pendingInput;
						pendingInput = null;
						goTo(direction);
					}
				};

				const goTo = (direction: number) => {
					if (isScrolling) return;
					isScrolling = true;
					currentIndex = currentIndex + direction;
					scrollToCard(currentIndex, true);
				};

				viewport.addEventListener('scroll', () => {
					if (scrollEndTimer !== null) {
						clearTimeout(scrollEndTimer);
					}
					scrollEndTimer = setTimeout(() => {
						isScrolling = false;
						const nearestIndex = findNearestIndex();
						if (nearestIndex !== currentIndex) {
							currentIndex = nearestIndex;
						}
						handleInfiniteLoop();
						processPendingInput();
					}, 50);
				}, { passive: true });

				prevButton.addEventListener('click', () => {
					if (isScrolling) {
						pendingInput = -1;
					} else {
						goTo(-1);
					}
				});
				
				nextButton.addEventListener('click', () => {
					if (isScrolling) {
						pendingInput = 1;
					} else {
						goTo(1);
					}
				});
				
				window.addEventListener('resize', () => {
					scrollToCard(currentIndex, false);
				});
				
				scrollToCard(currentIndex, false);
			}
		}
	</script>

	<section class="work-experience">
		<h4>Work Experience</h4>
		{sortedExperience.map((entry) => (
			<ExperienceEntry 
				title={entry.title}
				company={entry.company}
				years={entry.years}
				html={entry.html}
			/>
		))}
	</section>

	<section class="education">
		<h4>Education</h4>
		{sortedEducation.map((entry) => (
			<EducationEntry 
				title={entry.title}
				institution={entry.institution}
				period={entry.period}
				html={entry.html}
			/>
		))}
	</section>
</Layout>
