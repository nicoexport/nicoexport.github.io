---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import GitHubIconUrl from '../../assets/icons/github.svg?url';
import SteamIconUrl from '../../assets/icons/steam.svg?url';
import ItchIconUrl from '../../assets/icons/itch.svg?url';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const posts = (await getCollection('projects')).filter(post => !post.data.draft);

// Sort by start year (handles single year or ranges like "2019-2021")
posts.sort((a, b) => {
  const extract = (s: string) => {
    const m = String(s).match(/(\d{4})/);
    return m ? parseInt(m[1], 10) : 0;
  };
  return extract(b.data.year) - extract(a.data.year);
});

// Group posts by category
const postsByCategory = posts.reduce((acc: Record<string, typeof posts>, post) => {
  const category = post.data.category || 'Other';
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(post);
  return acc;
}, {});

// Define category order
const categoryOrder = ['Commercial', 'Academic', 'Student Projects', 'Jams and Other'];
const orderedCategories = categoryOrder.filter(cat => postsByCategory[cat]).concat(
  Object.keys(postsByCategory).filter(cat => !categoryOrder.includes(cat))
);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <style>
      main { width: 960px; }
      .category-section { margin-bottom: 3rem; }
      .category-section h2 { margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid rgb(var(--accent)); }
      ul { display:flex; flex-wrap:wrap; gap:2rem; list-style:none; margin:0; padding:0 }
      ul li { width: calc(50% - 1rem); }
      ul li > a { text-decoration: none; display: block; }
      ul li > a > img { 
        margin-bottom: 0.5rem; 
        border-radius: 12px;
        width: 100%;
        height: auto;
        aspect-ratio: 2 / 1;
        object-fit: cover;
        display: block;
      }
      .card-links { display:flex; gap:0.5rem; align-items:center; flex-shrink:0; }
      .card-links a { display:inline-block; text-decoration:none; color:inherit; flex-shrink:0; line-height:0; }
      .card-links img {
        width:22px !important;
        height:22px !important;
        display:block;
        object-fit:contain;
        margin-bottom:0;
        border-radius:0;
        aspect-ratio:auto;
      }
      .title-row { display: flex; align-items: center; gap: 0.75rem; margin: 0; flex-wrap:nowrap; }
      .title-row a { flex-shrink:1; min-width:0; text-decoration:none; }
      .title { margin:0; color: rgb(var(--black)); line-height:1.2; font-size:1.4rem; }
      .date { margin:0; color: rgb(var(--gray)) }
    </style>
  </head>
  <body>
    <Header />
    <main>
      {
        orderedCategories.map((category) => (
          <section class="category-section">
            <h2>{category}</h2>
            <ul>
              {
                postsByCategory[category].map((post) => (
                  <li>
                    <a href={`/projects/${post.id}/`}>
                      {post.data.heroImage && (<Image width={720} height={360} src={post.data.heroImage} alt="" />)}
                    </a>
                    <div class="title-row">
                      <a href={`/projects/${post.id}/`}>
                        <h4 class="title">{post.data.title}</h4>
                      </a>
                      {
                        ((post.data.github && post.data.github.trim()) || (post.data.steam && post.data.steam.trim()) || (post.data.itch && post.data.itch.trim())) && (
                          <div class="card-links">
                            {post.data.github && post.data.github.trim() && (
                              <a href={post.data.github} target="_blank" rel="noopener noreferrer" aria-label="GitHub">
                                <img src={GitHubIconUrl} alt="GitHub" />
                              </a>
                            )}
                            {post.data.steam && post.data.steam.trim() && (
                              <a href={post.data.steam} target="_blank" rel="noopener noreferrer" aria-label="Steam">
                                <img src={SteamIconUrl} alt="Steam" />
                              </a>
                            )}
                            {post.data.itch && post.data.itch.trim() && (
                              <a href={post.data.itch} target="_blank" rel="noopener noreferrer" aria-label="itch.io">
                                <img src={ItchIconUrl} alt="itch.io" />
                              </a>
                            )}
                          </div>
                        )
                      }
                    </div>
                    <a href={`/projects/${post.id}/`}>
                      <p class="date">{post.data.year}</p>
                    </a>
                  </li>
                ))
              }
            </ul>
          </section>
        ))
      }
    </main>
    <Footer />
  </body>
</html>
