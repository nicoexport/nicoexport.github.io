---
import AboutHeroImage from '../assets/about-me-header.png';
import Layout from '../layouts/BlogPost.astro';
import ExperienceEntry from '../components/ExperienceEntry.astro';
import EducationEntry from '../components/EducationEntry.astro';
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';

const _allProjects = await getCollection('projects');
const selectedProjects = _allProjects.filter((p) => (p.data && (p.data.selected === true || (p.data.tags && p.data.tags.includes('selected')))));
const experienceEntries = await getCollection('experience');
const educationEntries = await getCollection('education');

const experience = experienceEntries.map((entry) => ({
	...entry.data,
	html: entry.rendered?.html || '',
}));

const education = educationEntries.map((entry) => ({
	...entry.data,
	html: entry.rendered?.html || '',
}));

const sortedExperience = experience.sort((a, b) => {
	const aYears = a.years;
	const bYears = b.years;
	// Prioritize ongoing positions (with "present")
	const aIsPresent = aYears.includes('present');
	const bIsPresent = bYears.includes('present');
	if (aIsPresent && !bIsPresent) return -1;
	if (!aIsPresent && bIsPresent) return 1;
	// Otherwise sort by year descending
	const aFirstYear = parseInt(aYears.split('–')[0].trim());
	const bFirstYear = parseInt(bYears.split('–')[0].trim());
	return bFirstYear - aFirstYear;
});

const sortedEducation = education.sort((a, b) => {
	const aPeriod = a.period;
	const bPeriod = b.period;
	// Prioritize ongoing education (with "Expected")
	const aIsOngoing = aPeriod.includes('Expected');
	const bIsOngoing = bPeriod.includes('Expected');
	if (aIsOngoing && !bIsOngoing) return -1;
	if (!aIsOngoing && bIsOngoing) return 1;
	// Otherwise sort by year descending
	const aYear = parseInt(aPeriod.match(/\d{4}/)?.[0] || '0');
	const bYear = parseInt(bPeriod.match(/\d{4}/)?.[0] || '0');
	return bYear - aYear;
});
---

<Layout
	title="About Me"
	description="Lorem ipsum dolor sit amet"
	year=""
	heroImage={AboutHeroImage}
	heroPortrait={true}
>
	<p>
		I am a game developer with hands-on experience in Unity and Godot, specializing in gameplay systems, tools development, and graphics programming.
		I am currently completing an MSc in Videogame Studies while teaching game development at university level and having shipped a commercial project.
	</p>

	<section class="work-experience">
		<h3>Work Experience</h3>
		{sortedExperience.map((entry) => (
			<ExperienceEntry 
				title={entry.title}
				company={entry.company}
				years={entry.years}
				html={entry.html}
			/>
		))}
	</section>

	<section class="education">
		<h3>Education</h3>
		{sortedEducation.map((entry) => (
			<EducationEntry 
				title={entry.title}
				institution={entry.institution}
				period={entry.period}
				html={entry.html}
			/>
		))}
	</section>

	<style>
		.selected-projects ul { display:flex; flex-wrap:wrap; gap:2rem; list-style:none; margin:0; padding:0 }
		.selected-projects ul li { width: calc(50% - 1rem); }
		.selected-projects ul li a { text-decoration:none; display:block; color:inherit }
		.selected-projects ul li img { margin-bottom:0.5rem; border-radius:12px; width:100%; height:auto; aspect-ratio:2 / 1; object-fit:cover; display:block }
		.selected-projects h2 { margin-top:2rem; }
		.selected-projects h4 { margin:0; color: rgb(var(--black)); line-height:1 }
		.selected-projects p { margin:0; color: rgb(var(--gray)) }
	</style>

	{selectedProjects.length > 0 && (
		<section class="selected-projects">
			<h3>Selected Projects</h3>
			<ul>
				{selectedProjects.map((post) => (
					<li>
						<a href={`/projects/${post.id}/`}>
							{post.data.heroImage && (
								<Image width={720} height={360} src={post.data.heroImage} alt="" />
							)}
							<h4>{post.data.title}</h4>
							<p>{post.data.year}</p>
							{/* <p>{post.data.description}</p> */}
						</a>
					</li>
				))}
			</ul>
		</section>
	)}
</Layout>
